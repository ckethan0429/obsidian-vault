# Clawdbot 브라우저 자동화 이슈 해결 정리 (2026-01-29)

## TL;DR
- snap Chromium이 `~/.clawdbot/browser/<profile>/user-data` 아래에 `SingletonLock`(락 파일/심링크)을 만들려 할 때 **AppArmor DENIED**가 발생.
- 이 때문에 Clawdbot가 **로컬 Chromium 프로필을 직접 launch**하는 경로가 실패/타임아웃.
- 해결: Clawdbot가 Chromium을 직접 띄우지 않게 하고,
  **별도로 띄운 headless Chromium(CDP)** 에 Clawdbot가 **attach**하도록 구성.

---

## 증상
- `clawdbot browser start --browser-profile clawd` 실행 시 반복 타임아웃:
  - `Can't reach the clawd browser control server ... /start?profile=clawd (timed out ...)`
- snap chromium 관련 커널/저널 로그에서 AppArmor 거부 확인:
  - `apparmor="DENIED" operation="symlink" ... name="/home/ck/.clawdbot/browser/clawd/user-data/SingletonLock"`

## 원인(추정)
- Clawdbot는 프로필별 user-data-dir을 `~/.clawdbot/browser/<profile>/user-data`로 생성하고,
  Chromium을 `--user-data-dir=...`로 실행.
- snap 패키지(chromium)는 AppArmor confinement 때문에 특정 경로/파일 작업(특히 락/심링크 등)이 거부될 수 있음.
- 결과적으로 Chromium 프로세스가 정상적으로 기동/락 생성에 실패 → CDP 포트가 안 올라옴 → Clawdbot start가 타임아웃.

## 해결 접근
### 1) Chromium을 Clawdbot 밖에서 먼저 띄우기
- headless Chromium을 별도 user-data-dir로 실행하고 CDP를 열어둠:

```bash
mkdir -p "$HOME/snap/chromium/common/clawd-cdp"
nohup /snap/bin/chromium \
  --headless=new \
  --disable-gpu \
  --no-sandbox \
  --remote-debugging-address=127.0.0.1 \
  --remote-debugging-port=9222 \
  --user-data-dir="$HOME/snap/chromium/common/clawd-cdp" \
  about:blank \
  > /tmp/clawd-chromium-headless.log 2>&1 &

# CDP 확인
curl -sS http://127.0.0.1:9222/json/version
```

### 2) Clawdbot 브라우저 프로필을 remote CDP로 attach
- `browser.profiles.clawd.cdpUrl = http://127.0.0.1:9222`로 설정해
  Clawdbot가 local launch 대신 **attach-only remote profile**로 붙도록 구성.

현재 적용된 설정(요약):
- `browser.enabled: true`
- `browser.headless: true`
- `browser.noSandbox: true`
- `browser.defaultProfile: "clawd"`
- `browser.profiles.clawd.cdpUrl: "http://127.0.0.1:9222"`

## 결과
- `clawdbot browser status`에서:
  - `running: true`, `cdpReady: true`, `cdpUrl: http://127.0.0.1:9222`
- headless 환경에서도 Threads 페이지 네비게이션 가능.

## 남은 과제
- Threads 전체(리포스트/좋아요 등) 수집에는 로그인 세션이 필요.
  - 추천: GUI 환경(PC)에서 Browser Relay로 로그인된 탭 attach
  - 또는: 쿠키 이관(로그인 세션 쿠키 import)

