name: Podcast TTS â†’ Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (default: podcast-YYYYMMDD-HHMM)"
        required: false
      title:
        description: "Release title (default: Podcast TTS YYYY-MM-DD HH:MM)"
        required: false
      ko_script:
        description: "Path to Korean script markdown"
        required: false
        default: "podcast/scripts/ep01_ko.md"
      en_script:
        description: "Path to English script markdown"
        required: false
        default: "podcast/scripts/ep01_en_b2.md"
      generate_ko:
        description: "Generate Korean audio (true/false)"
        required: false
        default: "true"
      generate_en:
        description: "Generate English audio (true/false)"
        required: false
        default: "true"
      ko_voice_name:
        description: "Korean voice name preference (default: Adam)"
        required: false
        default: "Adam"
      en_voice_name:
        description: "English voice name preference (default: Rachel)"
        required: false
        default: "Rachel"
      ko_voice_id:
        description: "Optional: explicit ElevenLabs voice_id for Korean"
        required: false
      en_voice_id:
        description: "Optional: explicit ElevenLabs voice_id for English"
        required: false
      eleven_model:
        description: "ElevenLabs model_id (default: eleven_multilingual_v2)"
        required: false
        default: "eleven_multilingual_v2"
      output_format:
        description: "Output format (default: mp3_44100_128; try mp3_22050_32 if 402/plan limits)"
        required: false
        default: "mp3_44100_128"

permissions:
  contents: write

jobs:
  tts_and_release:
    runs-on: ubuntu-latest
    env:
      ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
      ELEVEN_MODEL: ${{ github.event.inputs.eleven_model || 'eleven_multilingual_v2' }}
      OUTPUT_FORMAT: ${{ github.event.inputs.output_format || 'mp3_44100_128' }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate secret
        run: |
          if [ -z "${ELEVENLABS_API_KEY}" ]; then
            echo "Missing ELEVENLABS_API_KEY secret" >&2
            exit 1
          fi
          # Don't print the key; just sanity-check it isn't obviously empty/whitespace.
          KEY_LEN=$(printf "%s" "$ELEVENLABS_API_KEY" | wc -c | tr -d ' ')
          echo "ELEVENLABS_API_KEY length: $KEY_LEN"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Resolve release metadata
        id: meta
        run: |
          NOW_TAG="podcast-$(date -u +%Y%m%d-%H%M)"
          NOW_TITLE="Podcast TTS $(date -u +%Y-%m-%d\ %H:%M) UTC"

          TAG_INPUT="${{ github.event.inputs.tag }}"
          TITLE_INPUT="${{ github.event.inputs.title }}"

          if [ -n "$TAG_INPUT" ]; then TAG="$TAG_INPUT"; else TAG="$NOW_TAG"; fi
          if [ -n "$TITLE_INPUT" ]; then TITLE="$TITLE_INPUT"; else TITLE="$NOW_TITLE"; fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Resolve voice IDs
        id: voices
        run: |
          set -euo pipefail

          KO_VOICE_ID_INPUT="${{ github.event.inputs.ko_voice_id }}"
          EN_VOICE_ID_INPUT="${{ github.event.inputs.en_voice_id }}"
          KO_VOICE_NAME="${{ github.event.inputs.ko_voice_name }}"
          EN_VOICE_NAME="${{ github.event.inputs.en_voice_name }}"

          echo "Inputs: generate_ko=${{ github.event.inputs.generate_ko }}, generate_en=${{ github.event.inputs.generate_en }}"
          echo "Inputs: ko_voice_id provided? $([ -n "$KO_VOICE_ID_INPUT" ] && echo yes || echo no)"
          echo "Inputs: en_voice_id provided? $([ -n "$EN_VOICE_ID_INPUT" ] && echo yes || echo no)"
          echo "Inputs: ko_voice_name='${KO_VOICE_NAME}', en_voice_name='${EN_VOICE_NAME}'"

          # Use explicit IDs when provided (independently). Only fetch /v1/voices for the missing ones.
          if [ -n "$KO_VOICE_ID_INPUT" ]; then
            KO_VOICE_ID="$KO_VOICE_ID_INPUT"
          fi
          if [ -n "$EN_VOICE_ID_INPUT" ]; then
            EN_VOICE_ID="$EN_VOICE_ID_INPUT"
          fi

          # If an explicit ID was provided, it MUST be honored.
          if [ -n "$KO_VOICE_ID_INPUT" ] && [ -n "${KO_VOICE_ID:-}" ] && [ "$KO_VOICE_ID" != "$KO_VOICE_ID_INPUT" ]; then
            echo "BUG: ko_voice_id input not honored" >&2
            exit 5
          fi
          if [ -n "$EN_VOICE_ID_INPUT" ] && [ -n "${EN_VOICE_ID:-}" ] && [ "$EN_VOICE_ID" != "$EN_VOICE_ID_INPUT" ]; then
            echo "BUG: en_voice_id input not honored" >&2
            exit 5
          fi

          # If both are set, we can skip /v1/voices entirely.
          if [ -n "${KO_VOICE_ID:-}" ] && [ -n "${EN_VOICE_ID:-}" ]; then
            echo "ko_voice_id=$KO_VOICE_ID" >> $GITHUB_OUTPUT
            echo "en_voice_id=$EN_VOICE_ID" >> $GITHUB_OUTPUT
            echo "Using explicit voice IDs (skipping /v1/voices)."
            exit 0
          fi

          # Otherwise, query voices and pick by name (fallback to first voice) for whichever is missing.
          # NOTE: This requires the ElevenLabs API key permission: voices_read.
          set +e
          HTTP_CODE=$(curl -sS \
            -H "xi-api-key: ${ELEVENLABS_API_KEY}" \
            -o voices.json \
            -w "%{http_code}" \
            https://api.elevenlabs.io/v1/voices)
          CURL_EXIT=$?
          set -e

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "curl failed fetching voices (exit=$CURL_EXIT, http=$HTTP_CODE)" >&2
            cat voices.json >&2 || true
            exit 5
          fi

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "ElevenLabs /v1/voices returned HTTP $HTTP_CODE" >&2
            cat voices.json >&2 || true
            echo "If you see missing_permissions for voices_read, either add that permission to the API key or provide ko_voice_id + en_voice_id when running the workflow." >&2
            exit 5
          fi

          VOICES_JSON=$(cat voices.json)

          if ! echo "$VOICES_JSON" | jq -e '.voices | type == "array"' > /dev/null; then
            echo "Unexpected response from ElevenLabs /v1/voices:" >&2
            echo "$VOICES_JSON" | jq -C . || echo "$VOICES_JSON" >&2
            exit 5
          fi

          if [ -z "${KO_VOICE_ID:-}" ]; then
            KO_VOICE_ID=$(echo "$VOICES_JSON" | jq -r --arg n "$KO_VOICE_NAME" '.voices[]? | select(.name==$n) | .voice_id' | head -n 1)
            if [ -z "$KO_VOICE_ID" ] || [ "$KO_VOICE_ID" = "null" ]; then
              KO_VOICE_ID=$(echo "$VOICES_JSON" | jq -r '.voices[0].voice_id')
            fi
          fi

          if [ -z "${EN_VOICE_ID:-}" ]; then
            EN_VOICE_ID=$(echo "$VOICES_JSON" | jq -r --arg n "$EN_VOICE_NAME" '.voices[]? | select(.name==$n) | .voice_id' | head -n 1)
            if [ -z "$EN_VOICE_ID" ] || [ "$EN_VOICE_ID" = "null" ]; then
              EN_VOICE_ID=$(echo "$VOICES_JSON" | jq -r '.voices[0].voice_id')
            fi
          fi

          echo "ko_voice_id=$KO_VOICE_ID" >> $GITHUB_OUTPUT
          echo "en_voice_id=$EN_VOICE_ID" >> $GITHUB_OUTPUT

          echo "Korean voice_id: $KO_VOICE_ID (name preference: $KO_VOICE_NAME)"
          echo "English voice_id: $EN_VOICE_ID (name preference: $EN_VOICE_NAME)"

      - name: Generate Korean MP3
        if: ${{ github.event.inputs.generate_ko != 'false' }}
        run: |
          set -euo pipefail
          KO_SCRIPT="${{ github.event.inputs.ko_script }}"
          if [ ! -f "$KO_SCRIPT" ]; then
            echo "KO script not found: $KO_SCRIPT" >&2
            exit 1
          fi

          # Strip markdown headers a bit: remove leading '# ' lines.
          KO_TEXT=$(cat "$KO_SCRIPT" | sed '/^# /d' )

          # Generate and capture error body if it fails
          set +e
          KO_HTTP=$(curl -sS \
            -H "xi-api-key: ${ELEVENLABS_API_KEY}" \
            -H "Content-Type: application/json" \
            -o ep01_ko.mp3 \
            -w "%{http_code}" \
            "https://api.elevenlabs.io/v1/text-to-speech/${{ steps.voices.outputs.ko_voice_id }}?output_format=${OUTPUT_FORMAT}" \
            -d "$(jq -n --arg text "$KO_TEXT" --arg model "$ELEVEN_MODEL" '{text:$text, model_id:$model, language_code:"ko", voice_settings:{stability:0.45, similarity_boost:0.75}}')")
          KO_CURL_EXIT=$?
          set -e

          if [ "$KO_CURL_EXIT" -ne 0 ] || [ "$KO_HTTP" -lt 200 ] || [ "$KO_HTTP" -ge 300 ]; then
            echo "ElevenLabs KO TTS failed (curl_exit=$KO_CURL_EXIT http=$KO_HTTP)" >&2
            # If server returned JSON error, the mp3 file will actually contain that body.
            head -c 2000 ep01_ko.mp3 >&2 || true
            echo >&2
            echo "Tip: 402 usually means credits/plan limit. Try output_format=mp3_22050_32 or check ElevenLabs usage/billing." >&2
            exit 6
          fi

          ls -lah ep01_ko.mp3

      - name: Generate English MP3
        if: ${{ github.event.inputs.generate_en != 'false' }}
        run: |
          set -euo pipefail
          EN_SCRIPT="${{ github.event.inputs.en_script }}"
          if [ ! -f "$EN_SCRIPT" ]; then
            echo "EN script not found: $EN_SCRIPT" >&2
            exit 1
          fi

          EN_TEXT=$(cat "$EN_SCRIPT" | sed '/^# /d' )

          # Generate and capture error body if it fails
          set +e
          EN_HTTP=$(curl -sS \
            -H "xi-api-key: ${ELEVENLABS_API_KEY}" \
            -H "Content-Type: application/json" \
            -o ep01_en.mp3 \
            -w "%{http_code}" \
            "https://api.elevenlabs.io/v1/text-to-speech/${{ steps.voices.outputs.en_voice_id }}?output_format=${OUTPUT_FORMAT}" \
            -d "$(jq -n --arg text "$EN_TEXT" --arg model "$ELEVEN_MODEL" '{text:$text, model_id:$model, language_code:"en", voice_settings:{stability:0.35, similarity_boost:0.75}}')")
          EN_CURL_EXIT=$?
          set -e

          if [ "$EN_CURL_EXIT" -ne 0 ] || [ "$EN_HTTP" -lt 200 ] || [ "$EN_HTTP" -ge 300 ]; then
            echo "ElevenLabs EN TTS failed (curl_exit=$EN_CURL_EXIT http=$EN_HTTP)" >&2
            head -c 2000 ep01_en.mp3 >&2 || true
            echo >&2
            echo "Tip: 402 usually means credits/plan limit. Try output_format=mp3_22050_32 or check ElevenLabs usage/billing." >&2
            exit 7
          fi

          ls -lah ep01_en.mp3

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: podcast-mp3
          if-no-files-found: error
          path: |
            ep01_ko.mp3
            ep01_en.mp3

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.title }}
          body: |
            Auto-generated podcast audio via ElevenLabs TTS.

            Scripts:
            - KO: `${{ github.event.inputs.ko_script }}` (voice: `${{ github.event.inputs.ko_voice_name }}`)
            - EN: `${{ github.event.inputs.en_script }}` (voice: `${{ github.event.inputs.en_voice_name }}`)
          files: |
            ep01_ko.mp3
            ep01_en.mp3
